#!/usr/bin/perl
use strict;

=begin metadata

Name: date
Description: display or set date and time
Author: brian d foy, brian.d.foy@gmail.com
Author: Joshua Gross
License: artistic2

=end metadata

=cut

use POSIX;
use Time::Piece;
Time::Piece->use_locale;

my $VERSION = '1.0.1';

my $format = "%a %b %e %T %Z %Y";
my $t = localtime;

sub core_time { CORE::localtime }

foreach (@ARGV) {
    chomp;
       if( /^\-u/ ) { $t = gmtime; *core_time = sub { CORE::gmtime } }
    elsif( /^\+/  ) { ($format = $_) =~ s/(^\+)// }
    else {
        usage("$_ is not supported in this version.\n");
        }
    }

my %formats = (
    'P' => lc( ampm($t->hour) ),
    'q' => quarter($t),
);

my @POSIX = qw(
    a A b B c C d D e F g G h H I j k l m M
    n p r R s S t T u U V w W x X y Y z Z
    );
@formats{ @POSIX } = map { POSIX::strftime( "%$_", core_time() ) } @POSIX;

$format =~ s/%(.)/ exists $formats{$1} ? $formats{$1} : "%$1" /eg;
print $format, "\n";

sub ampm { $_[0] >= 12 ? return "PM" : return "AM" }

sub quarter {
    my( $t ) = @_;

       if( $t->mon <= 3 ) { 1 }
    elsif( $t->mon <= 6 ) { 2 }
    elsif( $t->mon <= 9 ) { 3 }
    else             { 4 }
    }

sub usage {
    die <<"USAGE";
$_[0]."usage: $0".' [-u] [+format]

formats
%% - The character %
%a - Three-letter weekday name
%A - Full weekday name
%b - Three-letter month name
%B - Full month name
%c - locale version of the date-time string
%C - Century (00-99)
%d - Day of month (padded w/ zero)
%D - Date in MM/DD/YY format
%e - Day of month (padded w/ space)
%F - %Y-%m-%d
%g - ISO 8601 year
%G - ISO 8601 year
%h - Three-letter month name
%H - Hour HH
%I - Hour HH (12 hour)
%j - Three-digit Julian day
%k - Hour - space padded
%l - Hour - space padded (12 hour)
%m - Month number 01-12
%M - Minute MM
%n - Newline
%p - AM or PM
%r - Time in HH(12 hour):MM:SS (AM|PM) format
%R - Time in HH:MM format
%s - Absolute seconds (since epoch)
%S - Seconds SS
%t - Tab
%T - Time in HH:MM:SS format.
%u - Day of week, 1=Monday, 7=Sunday.
%U - Two digit week number, start Sunday.
%V - ISO week number, with Monday as the first day of week
%w - Day of week, 0=Sunday, 6=Saturday.
%W - Two digit week number, start Monday.
%x - locale's date representation
%X - locale's time representation
%y - Two-digit year.
%Y - Four-digit year.
%z - Time zone offset in hours.
%Z - Time zone code.
USAGE
}

=encoding utf8

=head1 NAME

date - display or set date and time

=cut
