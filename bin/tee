#!/usr/bin/perl

=begin metadata

Name: tee
Description: pipe fitting
Author: Tom Christiansen, tchrist@perl.com
License: perl

=end metadata

=cut


#
# tee clone that groks process tees (should work even with old perls)
# Tom Christiansen <tchrist@convex.com>
# 6 June 91

use Getopt::Std qw(getopts);

my %opt;
getopts('aiu', \%opt) or die "usage: tee [-aiu] [file ...]\n";
$SIG{'INT'} = 'IGNORE' if $opt{'i'};
$SIG{'PIPE'} = 'PLUMBER';
$| = 1 if $opt{'u'};

my $mode = $opt{'a'} ? '>>' : '>';
my $fh = 'FH000';
my %fh = ('STDOUT', 'standard output'); # always go to stdout
my $status = 0;

for (@ARGV) {
    if (!open($fh, $mode, $_)) {
	warn "$0: cannot open $_: $!\n"; # like sun's; i prefer die
	$status++;
	next;
    }
    select((select($fh), $| = 1)[0]) if $unbuffer;
    $fh{$fh++} = $_;
}
while (<STDIN>) {
    for my $fh (keys %fh) {
	print {$fh} $_;
    }
}
for my $fh (keys %fh) {
    next if close($fh) || !defined $fh{$fh};
    warn "$0: couldn't close $fh{$fh}: $!\n";
    $status++;
}
exit $status;

sub PLUMBER {
    warn "$0: pipe to \"$fh{$fh}\" broke!\n";
    $status++;
    delete $fh{$fh};
}

=encoding utf8

=head1 NAME

tee - pipe fitting
